<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head><!-- ViewVC - http://viewvc.org/
by Greg Stein - mailto:gstein@lyra.org --><title>uart_ow_test/main.adb</title>

<meta name="generator" content="ViewVC 1.0-dev">
<link rel="stylesheet" href="uart_ow_test_main.adb_files/styles.css" type="text/css"></head>


<body>
<div id="vc_markup"><pre><b><font color="#a020f0">with</font></b> Interfaces;                   <b><font color="#a020f0">use</font></b> Interfaces;

<b><font color="#a020f0">with</font></b> AVR.IO;                       <b><font color="#a020f0">use</font></b> AVR.IO;
<b><font color="#a020f0">with</font></b> AVR.ATmega169;                <b><font color="#a020f0">use</font></b> AVR.ATmega169;

<b><font color="#a020f0">with</font></b> AVR.UART;                     <b><font color="#a020f0">use</font></b> AVR.UART;

<b><font color="#a020f0">with</font></b> One_Wire;
<b><font color="#a020f0">with</font></b> One_Wire.Search;
<b><font color="#a020f0">with</font></b> One_Wire.Temperature_Sensors; <b><font color="#a020f0">use</font></b> One_Wire.Temperature_Sensors;
<b><font color="#a020f0">with</font></b> One_Wire.ROM;

<b><font color="#a020f0">with</font></b> Temperatures;                 <b><font color="#a020f0">use</font></b> Temperatures;

<b><font color="#a020f0">procedure</font></b> Main <b><font color="#a020f0">is</font></b>

   <b><font color="#a020f0">procedure</font></b> Wait_Long <b><font color="#a020f0">is</font></b>
   <b><font color="#a020f0">begin</font></b>
      <b><font color="#a020f0">for</font></b> I <b><font color="#a020f0">in</font></b> 1 .. 5000 <b><font color="#a020f0">loop</font></b>
         <b><font color="#a020f0">for</font></b> J <b><font color="#a020f0">in</font></b> 1 .. 1000 <b><font color="#a020f0">loop</font></b>
            <b><font color="#a020f0">null</font></b>;
         <b><font color="#a020f0">end</font></b> <b><font color="#a020f0">loop</font></b>;
      <b><font color="#a020f0">end</font></b> <b><font color="#a020f0">loop</font></b>;
      <b><font color="#a020f0">null</font></b>;
   <b><font color="#a020f0">end</font></b> Wait_Long;

   Found : Boolean;
   Temperature : Temperature_9bit;

   Max_OW_Devices : <b><font color="#a020f0">constant</font></b> := 5;
   <b><font color="#a020f0">subtype</font></b> OW_Device_Range <b><font color="#a020f0">is</font></b> Unsigned_8 <b><font color="#a020f0">range</font></b> 0 .. Max_OW_Devices;
   <b><font color="#a020f0">subtype</font></b> OW_Valid_Device_Range <b><font color="#a020f0">is</font></b> OW_Device_Range <b><font color="#a020f0">range</font></b> 1 .. Max_OW_Devices;

   <b><font color="#a020f0">type</font></b> OW_Device_A <b><font color="#a020f0">is</font></b> <b><font color="#a020f0">array</font></b> (OW_Valid_Device_Range)
     <b><font color="#a020f0">of</font></b> One_Wire.ROM.Unique_Serial_Code;
   <b><font color="#a020f0">type</font></b> OW_Temp_A <b><font color="#a020f0">is</font></b> <b><font color="#a020f0">array</font></b> (OW_Valid_Device_Range) <b><font color="#a020f0">of</font></b> Temperature_12bit;

   OW_Devices : OW_Device_A;
   OW_Temps   : OW_Temp_A;

   OW_Sensor_Index : OW_Device_Range;
   Last_Sensor     : OW_Device_Range;
<b><font color="#a020f0">begin</font></b>


   <i><font color="#b22222">-- OSCCAL_calibration;       -- calibrate the OSCCAL byte
</font></i>
   Set (CLKPR, CLKPCE);         <i><font color="#b22222">-- set Clock Prescaler Change Enable
</font></i>
   <i><font color="#b22222">-- set prescaler = 8, Inter RC 8Mhz / 8 = 1Mhz
</font></i>   <i><font color="#b22222">-- Set (CLKPR, BN (CLKPS1) or BN (CLKPS0)); -- 1MHz
</font></i>   Set (CLKPR, 0); <i><font color="#b22222">-- 8MHz
</font></i>
   AVR.UART.Init (51);            <i><font color="#b22222">-- Baud rate = 9600bps, 1MHZ, u2x=1
</font></i>
   Put_Line (<font color="#bc8f8f"><b>"1-Wire Test to serial output"</b></font>);


   <i><font color="#b22222">--  init LED channel: 5 on, 6 off
</font></i><i><font color="#b22222">--     Set_Bit (DDRE, 5, True);
</font></i><i><font color="#b22222">--     Set_Bit (DDRE, 6, True);
</font></i><i><font color="#b22222">--     Set_Bit (PORTE, 5, True);
</font></i><i><font color="#b22222">--     Set_Bit (PORTE, 6, False);
</font></i>
   <i><font color="#b22222">--  init time base
</font></i>   Set (TCCR1B, CS10);
   Set16 (TCNT1, 16#FFFF#);

   <b><font color="#a020f0">loop</font></b>
      New_Line (2);
      Put_Line (<font color="#bc8f8f"><b>" 1-Wire Test to serial output"</b></font>);

      OW_Sensor_Index := 1;
      Last_Sensor     := 0;


      <i><font color="#b22222">--  first find all devices
</font></i>      Found := One_Wire.Search.First;
      <b><font color="#a020f0">if</font></b> Found <b><font color="#a020f0">then</font></b>
         <b><font color="#a020f0">loop</font></b>
            OW_Devices (OW_Sensor_Index) := One_Wire.ROM.Identifier;
            Last_Sensor := OW_Sensor_Index;
            OW_Sensor_Index := OW_Sensor_Index + 1;

            Found := One_Wire.Search.Next;
            <b><font color="#a020f0">exit</font></b> <b><font color="#a020f0">when</font></b> <b><font color="#a020f0">not</font></b> Found;
         <b><font color="#a020f0">end</font></b> <b><font color="#a020f0">loop</font></b>;

      <b><font color="#a020f0">else</font></b>
         Put_Line (<font color="#bc8f8f"><b>"error: search found no device"</b></font>);
      <b><font color="#a020f0">end</font></b> <b><font color="#a020f0">if</font></b>;


      <i><font color="#b22222">--  print list of found IDs
</font></i>      <b><font color="#a020f0">for</font></b> Idx <b><font color="#a020f0">in</font></b> 1 .. Last_Sensor <b><font color="#a020f0">loop</font></b>
         Put (<font color="#bc8f8f"><b>"ID "</b></font>);
         Put (Unsigned_8 (Idx));
         Put (<font color="#bc8f8f"><b>":  "</b></font>);
         <b><font color="#a020f0">for</font></b> J <b><font color="#a020f0">in</font></b> One_Wire.ROM.Serial_Code_Index <b><font color="#a020f0">loop</font></b>
            Put (OW_Devices (Idx)(J), 16);
            Put (<font color="#bc8f8f"><b>' '</b></font>);
         <b><font color="#a020f0">end</font></b> <b><font color="#a020f0">loop</font></b>;
         New_Line;
      <b><font color="#a020f0">end</font></b> <b><font color="#a020f0">loop</font></b>;

      Wait_Long;


      <i><font color="#b22222">--  start conversion for all sensors
</font></i>      One_Wire.ROM.Identifier (1) := 0;
      One_Wire.Temperature_Sensors.Init_T_Conversion;

      <b><font color="#a020f0">for</font></b> I <b><font color="#a020f0">in</font></b> 1 .. 50 <b><font color="#a020f0">loop</font></b> Wait_Long; <b><font color="#a020f0">end</font></b> <b><font color="#a020f0">loop</font></b>;

      <i><font color="#b22222">--  request temp reading
</font></i>      <b><font color="#a020f0">for</font></b> Idx <b><font color="#a020f0">in</font></b> 1 .. Last_Sensor <b><font color="#a020f0">loop</font></b>
         One_Wire.ROM.Identifier := OW_Devices (Idx);
         OW_Temps (Idx) := Read_Temperature;
      <b><font color="#a020f0">end</font></b> <b><font color="#a020f0">loop</font></b>;

      <i><font color="#b22222">--  print list of temperature readings
</font></i>      <b><font color="#a020f0">for</font></b> Idx <b><font color="#a020f0">in</font></b> 1 .. Last_Sensor <b><font color="#a020f0">loop</font></b>
         Put (<font color="#bc8f8f"><b>"ID "</b></font>);
         Put (Unsigned_8 (Idx));
         Put (<font color="#bc8f8f"><b>": T = "</b></font>);
         Put (Image (OW_Temps (Idx)));
         Put (<font color="#bc8f8f"><b>'C'</b></font>);
         New_Line;
      <b><font color="#a020f0">end</font></b> <b><font color="#a020f0">loop</font></b>;

      <b><font color="#a020f0">for</font></b> I <b><font color="#a020f0">in</font></b> 1 .. 50 <b><font color="#a020f0">loop</font></b> Wait_Long; <b><font color="#a020f0">end</font></b> <b><font color="#a020f0">loop</font></b>;

   <b><font color="#a020f0">end</font></b> <b><font color="#a020f0">loop</font></b>;

<b><font color="#a020f0">end</font></b> Main;

</body></html>