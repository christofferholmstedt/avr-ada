<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<title>AVR-Ada Usage</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"/>
<link rel="stylesheet" type="text/css" href="styles.css"/>
<style type="text/css">
  dt { font-weight: bold; }
</style>
</head>

<body text="#DCDEF2" link="#F0E59E" vlink="#C7B767" alink="#DEC3A9"
      bgcolor="#3A3C69">

<table width="95%" border="0" cellspacing="0" cellpadding="0" align="right">
 <tr>
  <td width="73%">
   <p>&nbsp;</p>
   <p>&nbsp;</p>
  </td>
  <td rowspan="2" width="27%">&nbsp; </td>
 </tr>
 <tr>
  <td width="73%">
   <h1>How to use the compiler</h1>
<p>Do not forget to put <code>/opt/avr/bin</code> (or
<code>/mingw/avr/bin</code> on Windows) in your <code>PATH</code>.</p>

<h2>Compiling</h2>
<p>Nowadays I use the GNAT project files for most projects.  There is
a standard project file avr.gpr in the /avr directory.  It contains
the following parameters for the compiler:</p>

<p><code><b>package</b> Compiler <b>is</b><br>
&nbsp;&nbsp;&nbsp;<b>for</b> Default_Switches ("Ada") <b>use</b><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;("-gdwarf-2",&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--<i>  generate debug symbols</i><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"-gnatt",&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--<i>  generate tree files for Xref and ASIS</i><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"-gnatwp",&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--<i>  warnings on ineffective pragma Inlines</i><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"-gnatwu",&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--<i>  warnings on unused entities</i><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"-gnatn",&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--<i>  enable inlining</i><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"-gnatp",&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--<i>  suppress run-time checks</i><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"-gnatVn",&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--<i>  no validity checks (smaller code)</i><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"-Os",&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--<i>  optimize for space</i><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"-frename-registers", --<i>  avoid false dependencies in scheduled code</i><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--<i>  Attempt to avoid false dependencies in scheduled code by</i><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--<i>  making use of registers left over after register</i><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--<i>  allocation.  This optimization will most benefit</i><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--<i>  processors with lots of registers. It can, however, make</i><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--<i>  debugging impossible, since variables will no longer stay</i><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--<i>  in a "home register".</i><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"-fnew-ra",&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--<i>  use the new register allocator</i><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--<i>  The new register allocator is actually deprecated</i><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--<i>  officially since the compiler might ICE over valid code.</i><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--<i>  I never had problems for the AVR target and it sometimes</i><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--<i>  produces considerably better code.</i><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"-mmcu=" & MCU,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--<i>  architecture or part</i><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"-fdata-sections",&nbsp;&nbsp;&nbsp;&nbsp;--<i>  create separate data sections</i><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"-ffunction-sections" --<i>  create separate function sections</i><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br>
&nbsp;&nbsp;&nbsp;<b>end</b> Compiler;
</code></p>

<p>Here are some other useful switches to consider:</p>

<dl>
 <dt><code>-gnatN</code>:</dt>
 <dd>enable front end inlining.  This does not work in gcc-3.4.  You
 must not use that switch.<p></dd>

<h2>Making</h2>
<p>We use a combination of the standard AVR-Libc Makefile and
Gnatmake.  The gnatmake program for AVR is named avr-gnatmake.  It
automatically calls avr-gcc, avr-gnatbind, and avr-gnatlink as
needed.</p>

<p>See the example in ./apps/examples on how to use Makefiles and GNAT
project files.</p>

<h2>Binding</h2>

<p>We switched to generating an Ada main programs (actually it is the
binder file) in version 0.2 of AVR-Ada .</p>

<p>When using gnatmake, it compiles a few packages, that you don't
actually need in the final executable.  Most notably these are the
part specific definitions like AVR.AT90S2313 and all generic packages.
If you delete the object files before running gnatbind, gnatmake will
omit these files at the link step.  Admittedly, this is a horrible
kludge.</p>

<p>However, gcc provides a nice way of removing unused code at the
link step.  This is achieved by compiling with the option
<code>-ffunction-sections</code> and linking with the option
<code>--gc-sections</code>.  See the corresponding entries in the gcc
and binutils documentation.

<p>I exceeded the code limit of 2kB on the AT90S2313 in one of my
projects.  Quite a lot of code and data is wasted in the generated
binder main program.  I made a patch to gnatbind that adds the new
option "-freestanding" (previously called "-standalone" in V0.1).
Using the option considerably reduces the size of the main program.
The freestanding-patch only affects the Ada main, not a C main
program.</p>

<p><code>avr-gnatbind -freestanding &lt;main-unit&gt;</code></p>

<h2>Linking</h2>

<p>avr-gnatlink first compiles the generated binder file (typically
called <code>b~&lt;main unit&gt;.adb</code>) and then calls the system
linker to link all provided .o files and the libraries.</p>

<p>Unfortunatly one cannot set the compiler options that are
used for compiling the binder file.  As a workaround one can set the
compiler that is to be used using <code>--GCC=</code>.  Together with
the compiler, one can set the necessary options.</p>

<p>Stack initialisation currently relies on using gcrt1.S from
avr-libc.  Eventually this will be replaced by an Ada specific
version.</p>

<p><code>avr-gnatlink --GCC="avr-gcc -Os -mmcu=xxx" &lt;main-unit&gt;</code></p>
  </td>
 </tr>
 <tr>
  <td>&nbsp;</td>
  <td>&nbsp;</td>
 </tr>
 <tr>
  <td>
   <P>
  </td>
  <td>
   <div align="right"></div>
  </td>
 </tr>
 <tr>
  <td>&nbsp;</td>
  <td>&nbsp;</td>
 </tr>
</table>

</body>
</html>
